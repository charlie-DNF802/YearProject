@model Ward_Management_System.ViewModels.PatientMovementFilterViewModel
@{
    ViewData["Title"] = "Patient Movement History";
    Layout = "~/Views/Shared/_UserLayout.cshtml";

    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">Patient Movement History</h2>
            <p class="text-muted">Monitor currently admitted patients movement</p>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="row justify-content-center mb-4">
        <form method="get" class="row g-3 col-md-10">
            <!-- Patient Name -->
            <div class="col-md-2">
                <input type="text" name="PatientName" value="@Model.PatientName"
                       class="form-control" placeholder="Patient Name" />
            </div>

            <!-- Ward -->
            <div class="col-md-2">
                <select name="WardId" class="form-select">
                    <option value="">-- Select Ward --</option>
                    @foreach (var ward in Model.AvailableWards)
                    {
                        <option value="@ward.WardId"
                                selected="@(Model.WardId == ward.WardId ? "selected" : null)">
                            @ward.WardName
                        </option>
                    }
                </select>
            </div>

            <!-- From Date -->
            <div class="col-md-2">
                <input type="date" name="FromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" class="form-control" />
            </div>

            <!-- To Date -->
            <div class="col-md-2">
                <input type="date" name="ToDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" class="form-control" />
            </div>

            <!-- Buttons -->
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-info flex-fill text-white">Filter</button>
                <a asp-action="MonitorMovement" asp-controller="WardAdmin" class="btn btn-secondary flex-fill">Clear</a>
                <a asp-controller="Reports" asp-action="ExportPatientMovementsToPDF"
                   asp-route-PatientName="@Model.PatientName"
                   asp-route-WardId="@Model.WardId"
                   asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                   asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                   class="btn btn-danger flex-fill">
                    Export PDF
                </a>
            </div>
        </form>
    </div>

    <!-- Movements Table -->
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                @if (Model.Movements == null || !Model.Movements.Any())
                {
                    <div class="alert alert-info text-center col-md-8 mx-auto shadow-sm">
                        No patient movements found for the selected filters.
                    </div>
                }
                else
                {
                    <div class="card-body">
                        <table class="table table-hover table-striped mb-0 align-middle" id="movementTable">
                            <thead class="table-primary">
                                <tr>
                                    <th>#</th>
                                    <th>Patient Name</th>
                                    <th>Id Number</th>
                                    <th>Ward</th>
                                    <th>Movement Time</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = ((pager.CurrentPage - 1) * pager.PageSize) + 1;
                                }
                                @foreach (var move in Model.Movements)
                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@move.PatientName</td>
                                        <td>@move.IdNumber</td>
                                        <td>@move.WardName</td>
                                        <td>@move.MovementTime.ToString("dd MMM yyyy HH:mm")</td>
                                        <td>@move.Notes</td>
                                    </tr>
                                    count++;
                                }
                            </tbody>
                        </table>
                        @*  Paging shared partial view *@
                        <div class="=container">
                            @if (pager.TotalPages > 0)
                            {
                                <ul class="pagination justify-content-end">
                                    @if (pager.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link"
                                               asp-controller="WardAdmin"
                                               asp-action="MonitorMovement"
                                               asp-route-pg="1"
                                               asp-route-PatientName="@Model.PatientName"
                                               asp-route-WardId="@Model.WardId"
                                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
                                                First
                                            </a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link"
                                               asp-controller="WardAdmin"
                                               asp-action="MonitorMovement"
                                               asp-route-pg="@(pager.CurrentPage - 1)"
                                               asp-route-PatientName="@Model.PatientName"
                                               asp-route-WardId="@Model.WardId"
                                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
                                                Previous
                                            </a>
                                        </li>
                                    }
                                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                    {
                                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                            <a class="page-link"
                                               asp-controller="WardAdmin"
                                               asp-action="MonitorMovement"
                                               asp-route-pg="@pge"
                                               asp-route-PatientName="@Model.PatientName"
                                               asp-route-WardId="@Model.WardId"
                                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
                                                @pge
                                            </a>
                                        </li>
                                    }
                                    @if (pager.CurrentPage < pager.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link"
                                               asp-controller="WardAdmin"
                                               asp-action="MonitorMovement"
                                               asp-route-pg="@(pager.CurrentPage + 1)"
                                               asp-route-PatientName="@Model.PatientName"
                                               asp-route-WardId="@Model.WardId"
                                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
                                                Next
                                            </a>
                                        </li>
                                        <li>
                                            <a class="page-link"
                                               asp-controller="WardAdmin"
                                               asp-action="MonitorMovement"
                                               asp-route-pg="@(pager.TotalPages)"
                                               asp-route-PatientName="@Model.PatientName"
                                               asp-route-WardId="@Model.WardId"
                                               asp-route-FromDate="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                                               asp-route-ToDate="@(Model.ToDate?.ToString("yyyy-MM-dd"))">
                                                Last
                                            </a>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-action="Index" asp-controller="WardAdmin" class="btn btn-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
</div>




