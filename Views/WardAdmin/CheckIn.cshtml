@model IEnumerable<Ward_Management_System.Models.Appointment>
@{
    ViewData["Title"] = "Today's Appointments";
    Layout = "~/Views/Shared/_UserLayout.cshtml";

    // Ensure the ViewBag contains the necessary data for pagination
    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
@if (TempData["ToastMessage"] != null)
{
    var toastType = TempData["ToastType"] ?? "success";
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-@toastType border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">Today's Appointments</h2>
            <p class="text-muted">Manage check-ins and monitor scheduled visits.</p>
        </div>
    </div>

    <!-- Filtering options -->
    <form method="get" asp-action="CheckIn" class="row justify-content-center mb-4">
        <!-- Date Picker -->
        <div class="col-md-2">
            <input type="date" class="form-control" name="selectedDate"
                   value="@(ViewBag.CurrentFilters.selectedDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <!-- Status Filter -->
        <div class="col-md-2">
            <select class="form-select" name="statusFilter">
                <option value="">All Statuses</option>
                <option value="Pending" selected="@(ViewBag.CurrentFilters.statusFilter == "Pending")">Pending</option>
                <option value="CheckedIn" selected="@(ViewBag.CurrentFilters.statusFilter == "CheckedIn")">CheckedIn</option>
                <option value="Admitted" selected="@(ViewBag.CurrentFilters.statusFilter == "Admitted")">Admitted</option>
            </select>
        </div>
        <!-- Age Group Filter -->
        <div class="col-md-2">
            <select class="form-select" name="ageFilter">
                <option value="">All Age Groups</option>
                <option value="child" selected="@(ViewBag.CurrentFilters.ageFilter == "child")">Under 18</option>
                <option value="young" selected="@(ViewBag.CurrentFilters.ageFilter == "young")">18-29</option>
                <option value="middle" selected="@(ViewBag.CurrentFilters.ageFilter == "middle")">30-49</option>
                <option value="senior" selected="@(ViewBag.CurrentFilters.ageFilter == "senior")">50+</option>
            </select>
        </div>
        <!-- Search by Patient Name -->
        <div class="col-md-2">
            <input type="text" class="form-control" name="searchName"
                   placeholder="Search by patient name"
                   value="@(ViewBag.CurrentFilters.searchName)" />
        </div>
        <!-- Buttons -->
        <div class="col-md-2 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Apply</button>
            <a asp-action="CheckIn" class="btn btn-secondary flex-fill">Clear</a>
            <a asp-controller="Reports" asp-action="ExportAppointmentsToPDF"
               asp-route-selectedDate="@(ViewBag.CurrentFilters.selectedDate?.ToString("yyyy-MM-dd"))"
               asp-route-statusFilter="@ViewBag.CurrentFilters.statusFilter"
               asp-route-ageFilter="@ViewBag.CurrentFilters.ageFilter"
               asp-route-searchName="@ViewBag.CurrentFilters.searchName"
               class="btn btn-danger flex-fill">
                Export PDF
            </a>

        </div>

    </form>


    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                @if (!Model.Any())
                {
                    <div class="alert alert-info text-center col-md-8 mx-auto shadow-sm">
                        No appointments scheduled for today.
                    </div>
                 
                }
                else
                {
                    <div class="card-body">
                        <table class="table table-hover align-middle" id="patientTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Patient</th>
                                    <th>Age</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = ((pager.CurrentPage - 1) * pager.PageSize) + 1;
                                }
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@item.FullName</td>
                                        <td>@item.Age</td>
                                        <td>@item.PreferredDate.ToString("dd/MM/yyyy")</td>
                                        <td>@item.PreferredTime.ToString(@"hh\:mm")</td>
                                        <td>@item.Reason</td>
                                        <td class="text-center">
                                            @if (item.Status == "CheckedIn")
                                            {
                                                <span class="badge bg-success">CheckedIn</span>
                                            }
                                            else if (item.Status == "Admitted")
                                            {
                                                <span class="badge bg-primary">Admitted</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Pending</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (item.Status == "CheckedIn")
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary ms-1" data-bs-toggle="modal" data-bs-target="#admitModal-@item.AppointmentId">
                                                    <i class="bi bi-hospital me-1"></i>Admit
                                                </button>
                                            }
                                            else if (item.Status == "Admitted")
                                            {
                                                <i class="bi bi-hospital-fill text-primary fs-5" title="Already Admitted"></i>
                                            }
                                            else
                                            {
                                               <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#checkInModal-@item.AppointmentId">
                                                   <i class="bi bi-check2-circle me-1"></i> Check In
                                               </button>
                                            }

                                        </td>
                                    </tr>
                                    count++;
                                    <!-- Admit Modal -->
                                    <div class="modal fade" id="admitModal-@item.AppointmentId" tabindex="-1" aria-labelledby="admitModalLabel-@item.AppointmentId" aria-hidden="true">
                                        <div class="modal-dialog modal-lg modal-dialog-centered">
                                            <div class="modal-content">
                                                <form asp-action="AdmitPatient" method="post">
                                                    @Html.AntiForgeryToken()
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="admitModalLabel-@item.AppointmentId">Admit @item.FullName</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body row g-3">
                                                        <input type="hidden" name="UserId" value="@item.UserId" />
                                                        <input type="hidden" name="AppointmentId" value="@item.AppointmentId" />
                                                        <input type="hidden" name="PatientName" value="@item.FullName" />

                                                        <div class="col-md-6">
                                                            <label for="AdmissionDate" class="form-label">Admission Date</label>
                                                            <input type="datetime-local" name="AdmissionDate" class="form-control" required value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                                                        </div>

                                                        <div class="col-md-6">
                                                            <label for="WardId" class="form-label">Ward</label>
                                                            <select name="WardId" class="form-select" required>
                                                                <option value="">-- Select Ward --</option>
                                                                @foreach (var ward in (List<SelectListItem>)ViewBag.Wards ?? new List<SelectListItem>())
                                                                {
                                                                    <option value="@ward.Value">@ward.Text</option>
                                                                }
                                                            </select>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <label for="Allergies" class="form-label">Allergies</label>
                                                            <input type="text" name="Allergies" class="form-control" required />
                                                        </div>

                                                        <div class="col-md-6">
                                                            <label for="Condition" class="form-label">Condition</label>
                                                            <input type="text" name="Condition" class="form-control" required />
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="submit" class="btn btn-primary">Admit</button>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    //CheckIn Modal
                                    <div class="modal fade" id="checkInModal-@item.AppointmentId" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form asp-action="CheckInPatient" method="post">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Check In Patient</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <input type="hidden" name="id" value="@item.AppointmentId" />

                                                        <label for="ConsultationRoomId" class="form-label">Select Consultation Room</label>
                                                        <select name="ConsultationRoomId" class="form-select" required>
                                                            <option value="">-- Select Room --</option>
                                                            @foreach (var room in (List<SelectListItem>)ViewBag.ConsultationRooms ?? new List<SelectListItem>())
                                                            {
                                                                <option value="@room.Value" disabled="@(room.Disabled ? "disabled" : null)">
                                                                    @room.Text
                                                                </option>
                                                            }
                                                        </select>

                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="submit" class="btn btn-success">Check In</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </tbody>
                        </table>
                        @*  Paging shared partial view *@
                        <div class="=container">
                            @if (pager.TotalPages > 0)
                            {
                                <ul class="pagination justify-content-end">
                                    @if (pager.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="CheckIn" asp-route-pg="1">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="CheckIn" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                        </li>
                                    }
                                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                    {
                                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="CheckIn" asp-route-pg="@pge">@pge</a>
                                        </li>
                                    }
                                    @if (pager.CurrentPage < pager.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="CheckIn" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                        </li>
                                        <li>
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="CheckIn" asp-route-pg="@(pager.TotalPages)">Last</a>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        <!-- Back Button -->
        <div class="text-center mt-4">
            <a asp-action="Index" asp-controller="WardAdmin" class="btn btn-secondary px-4">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById("toastMessage");
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        
    </script>
}


