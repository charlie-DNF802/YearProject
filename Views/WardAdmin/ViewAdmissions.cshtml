@model IEnumerable<Ward_Management_System.ViewModels.AdmissionViewModel>
@using Ward_Management_System.Models

@{
    ViewData["Title"] = "Admission List";
    Layout = "~/Views/Shared/_UserLayout.cshtml";

     Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
@{
    var ModelFolderList = (List<PatientFolder>)ViewBag.ModelFolderList;
}

@if (TempData["ToastMessage"] != null)
{
    var toastType = TempData["ToastType"] ?? "success";
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-@toastType border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">List Of  Patients</h2>
            <p class="text-muted">View and create patient folders.</p>
        </div>
    </div>
<!-- Filter Form -->
<form method="get" asp-action="ViewAdmissions" class="row justify-content-center mb-4">
    <!-- Location Filter -->
        <div class="col-md-2">
            <select class="form-select" name="locationFilter">
                <option value="">All Locations</option>
                @* Wards *@
                @foreach (var ward in ViewBag.WardList as List<Ward_Management_System.Models.Wards>)
                {
                    <option value="@ward.WardName" selected="@(ViewBag.CurrentFilters?.locationFilter == ward.WardName ? "selected" : null)">
                        @ward.WardName
                    </option>
                }
                @* Consultation Rooms *@
                @foreach (var room in ViewBag.ConsultationRooms as List<Ward_Management_System.Models.ConsultationRoom>)
                {
                    <option value="@room.RoomName" selected="@(ViewBag.CurrentFilters?.locationFilter == room.RoomName ? "selected" : null)">
                        @room.RoomName
                    </option>
                }
            </select>
        </div>


        <!-- Status Filter -->
        <div class="col-md-2">
            <select class="form-select" name="statusFilter">
                <option value="">All Statuses</option>
                <option value="Has Folder" selected="@(ViewBag.CurrentFilters?.statusFilter == "Has Folder" ? "selected" : null)">
                    Has Folder
                </option>
                <option value="No Folder" selected="@(ViewBag.CurrentFilters?.statusFilter == "No Folder" ? "selected" : null)">
                    No Folder
                </option>
            </select>
        </div>

    <!-- Search by Name or ID -->
        <div class="col-md-3">
            <input type="text" class="form-control" name="searchTerm" placeholder="Search by Name or ID"
                   value="@(ViewBag.CurrentFilters?.searchTerm ?? "")" />
        </div>

        <!-- Buttons -->
        <div class="col-md-3 d-flex gap-3">
            <button type="submit" class="btn btn-primary flex-fill">Apply</button>
            <a asp-action="ViewAdmissions" class="btn btn-secondary flex-fill">Clear</a>
            <a asp-controller="Reports" asp-action="ExportAdmissionsToPDF"
               asp-route-locationFilter="@ViewBag.CurrentFilters.locationFilter"
               asp-route-statusFilter="@ViewBag.CurrentFilters.statusFilter"
               asp-route-searchTerm="@ViewBag.CurrentFilters.searchTerm"
               class="btn btn-danger flex-fill">
                Export PDF
            </a>

        </div>
</form>

    <!-- Admissions Table -->
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                @if (!Model.Any())
                {
                    <div class="alert alert-info text-center col-md-8 mx-auto shadow-sm">
                        No Patients Admitted!
                    </div>
                }
                else
                {
                    <div class="card-body">
                            <table class="table table-hover align-middle" id="AdmissionTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Patient Name</th>
                                        <th>ID Number</th>
                                        <th>Location</th>
                                        <th>Folder Status</th>
                                        <th>Condition</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                    int count = ((pager.CurrentPage - 1) * pager.PageSize) + 1;
                                    }
                                    @foreach (var admission in Model)
                                    {
                                        <tr>
                                            <td>@count</td>
                                            <td>@admission.PatientName</td>
                                            <td>@admission.IdNumber</td>
                                            <td>@admission.WardName</td>
                                            <td>
                                                @if (admission.FolderStatus == "No Folder")
                                                {
                                                    <span class="badge bg-success">No Folder</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Has Folder</span>
                                                }
                                            </td>
                                            <td>@admission.Condition</td>
                                            <td>
                                                @if (admission.FolderStatus == "No Folder")
                                                {
                                                    <form asp-action="CreateFolder" asp-controller="WardAdmin" method="post">
                                                        <input type="hidden" name="appointmentId" value="@admission.AppointmentId" />
                                                        <button type="submit" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-folder-plus"></i> Create Folder
                                                        </button>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#folderModal-@admission.AppointmentId">
                                                        <i class="bi bi-folder2-open"></i> Open Folder
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                        count++;
                                    }
                                </tbody>
                            </table>
                        <!-- Folder Modals -->
                        @foreach (var admission in Model)
                        {
                            <div class="modal fade" id="folderModal-@admission.AppointmentId" tabindex="-1"
                                 aria-labelledby="folderModalLabel-@admission.AppointmentId" aria-hidden="true">
                                <!-- ✅ Added modal-dialog-scrollable -->
                                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                                    <div class="modal-content shadow-lg rounded-4">
                                        <div class="modal-header bg-primary text-white">
                                            <h5 class="modal-title fw-bold" id="folderModalLabel-@admission.AppointmentId">
                                                Folder for @admission.PatientName
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>

                                        <div class="modal-body p-4" style="max-height: 75vh; overflow-y: auto;">
                                            @{
                                                var folder = ModelFolderList.FirstOrDefault(f =>
                                                f.Appointment.FullName == admission.PatientName &&
                                                f.Appointment.IdNumber == admission.IdNumber);

                                                var latestTreatment = ((List<Treatment>)ViewBag.Treatments)
                                                .FirstOrDefault(t => t.Appointment.FullName == admission.PatientName &&
                                                t.Appointment.IdNumber == admission.IdNumber);

                                                var latestVitals = ((List<PatientVitals>)ViewBag.Vitals)
                                                .FirstOrDefault(v => folder != null && v.FolderId == folder.FolderId);

                                                var latestDischarge = ((List<DischargeInformation>)ViewBag.Discharges)
                                                .FirstOrDefault(d => d.Appointment.FullName == admission.PatientName &&
                                                d.Appointment.IdNumber == admission.IdNumber);
                                            }

                                            @if (folder != null)
                                            {
                                                <div class="row mb-3">
                                                    <div class="col-md-6"><strong>Created By:</strong> @folder.CreatedBy</div>
                                                    <div class="col-md-6"><strong>Created Date:</strong> @folder.CreatedDate.ToString("g")</div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-6"><strong>ID Number:</strong> @folder.Appointment.IdNumber</div>
                                                    <div class="col-md-6"><strong>Gender:</strong> @folder.Appointment.Gender</div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-md-6"><strong>Phone:</strong> @folder.Appointment.User.PhoneNumber</div>
                                                    <div class="col-md-6"><strong>Address:</strong> @folder.Appointment.User.Address</div>
                                                </div>

                                                <div class="mb-2">
                                                    <strong>Status:</strong>
                                                    @if (admission.Status == "Admitted")
                                                    {
                                                        <span class="badge bg-primary">Admitted</span>
                                                    }
                                                    else if (admission.Status == "CheckedIn")
                                                    {
                                                        <span class="badge bg-success">Checked In</span>
                                                    }
                                                </div>

                                                @if (folder.Appointment.User.EmergencyContacts != null && folder.Appointment.User.EmergencyContacts.Any())
                                                {
                                                    <hr />
                                                    <h5>Emergency Contacts</h5>
                                                    @foreach (var e in folder.Appointment.User.EmergencyContacts)
                                                    {
                                                        <div class="row mb-2">
                                                            <div class="col-md-4"><strong>Name:</strong> @e.EmergencyName</div>
                                                            <div class="col-md-4"><strong>Phone:</strong> @e.EmergencyPhone</div>
                                                            <div class="col-md-4"><strong>Relationship:</strong> @e.EmergencyRelationship</div>
                                                        </div>
                                                    }
                                                }

                                                <hr />
                                                <h5 class="mt-3 text-primary">Latest Medical History</h5>

                                                @if (latestTreatment != null)
                                                {
                                                    <h6 class="text-secondary mt-3">Latest Treatment</h6>
                                                    <table class="table table-sm table-bordered">
                                                        <tr><th>Date</th><td>@latestTreatment.TreatmentDate.ToString("g")</td></tr>
                                                        <tr><th>Procedure</th><td>@latestTreatment.Procedure</td></tr>
                                                        <tr><th>Notes</th><td>@latestTreatment.Notes</td></tr>
                                                        <tr><th>Recorded By</th><td>@(latestTreatment.RecordedBy?.FullName ?? "N/A")</td></tr>
                                                    </table>
                                                }

                                                @if (latestVitals != null)
                                                {
                                                    <h6 class="text-secondary mt-3">Latest Vitals</h6>
                                                    <table class="table table-sm table-bordered">
                                                        <tr><th>Date</th><td>@latestVitals.VitalsDate.ToString("g")</td></tr>
                                                        <tr><th>Blood Type</th><td>@latestVitals.BloodType</td></tr>
                                                        <tr><th>BP</th><td>@latestVitals.BloodPressure</td></tr>
                                                        <tr><th>Heart Rate</th><td>@latestVitals.HeartRate bpm</td></tr>
                                                        <tr><th>Temperature</th><td>@latestVitals.Temperature °C</td></tr>
                                                        <tr><th>Respiratory Rate</th><td>@latestVitals.RespiratoryRate</td></tr>
                                                        <tr><th>O₂ Sat</th><td>@latestVitals.OxygenSaturation%</td></tr>
                                                        <tr><th>Notes</th><td>@latestVitals.Notes</td></tr>
                                                    </table>
                                                }

                                                @if (latestDischarge != null)
                                                {
                                                    <h6 class="text-secondary mt-3">Latest Discharge</h6>
                                                    <table class="table table-sm table-bordered">
                                                        <tr><th>Date</th><td>@latestDischarge.DischargeDate.ToString("g")</td></tr>
                                                        <tr><th>Discharged By</th><td>@(latestDischarge.DischargedBy?.FullName ?? "N/A")</td></tr>
                                                        <tr><th>Summary</th><td>@latestDischarge.DischargeSummary</td></tr>
                                                    </table>
                                                }
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning">
                                                    No folder found for this patient.
                                                </div>
                                            }
                                        </div>

                                        <div class="modal-footer bg-light">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Close
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                          @*  Paging shared partial view *@
                        <div class="=container">
                            @if (pager.TotalPages > 0)
                            {
                                <ul class="pagination justify-content-end">
                                    @if (pager.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="ViewAdmissions" asp-route-pg="1">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="ViewAdmissions" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                        </li>
                                    }
                                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                    {
                                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="ViewAdmissions" asp-route-pg="@pge">@pge</a>
                                        </li>
                                    }
                                    @if (pager.CurrentPage < pager.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="ViewAdmissions" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                        </li>
                                        <li>
                                            <a class="page-link" asp-controller="WardAdmin" asp-action="ViewAdmissions" asp-route-pg="@(pager.TotalPages)">Last</a>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-action="Index" asp-controller="WardAdmin" class="btn btn-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
      <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById("toastMessage");
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
}

