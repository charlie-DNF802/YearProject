@model IEnumerable<Ward_Management_System.ViewModels.AdmissionViewModel>
@using Ward_Management_System.Models
@using System.Text.Json
@{
    ViewData["Title"] = "Admission List";
    Layout = "~/Views/Shared/_UserLayout.cshtml";

    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
@if (TempData["ToastMessage"] != null)
{
    var toastType = TempData["ToastType"] ?? "success";
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
            <div id="toastMessage" class="toast align-items-center text-bg-@toastType border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["ToastMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>
}

<div class="container-fluid patient-dashboard py-5">
    <div class="row justify-content-center mb-4 ">
        <div class="col-md-10 text-center">
            <h2 class="fw-bold text-primary">List Of Patients</h2>
            <p>View List Of Patients & their vitals</p>
        </div>
    </div>

    <!-- Filter Form -->
    <form method="get" asp-action="PatientList" class="row justify-content-center mb-4">
        <!-- (your existing filters here, unchanged) -->
        <div class="col-md-3">
            <select class="form-select" name="locationFilter">
                <option value="">All Locations</option>
                @foreach (var ward in ViewBag.WardList as List<Ward_Management_System.Models.Wards>)
                {
                    <option value="@ward.WardName" selected="@(ViewBag.CurrentFilters?.locationFilter == ward.WardName ? "selected" : null)">
                        @ward.WardName
                    </option>
                }
                @foreach (var room in ViewBag.ConsultationRooms as List<Ward_Management_System.Models.ConsultationRoom>)
                {
                    <option value="@room.RoomName" selected="@(ViewBag.CurrentFilters?.locationFilter == room.RoomName ? "selected" : null)">
                        @room.RoomName
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <select class="form-select" name="ageFilter">
                <option value="">All Age Groups</option>
                <option value="child" selected="@(ViewBag.CurrentFilters.ageFilter == "child")">Under 18</option>
                <option value="young" selected="@(ViewBag.CurrentFilters.ageFilter == "young")">18-29</option>
                <option value="middle" selected="@(ViewBag.CurrentFilters.ageFilter == "middle")">30-49</option>
                <option value="senior" selected="@(ViewBag.CurrentFilters.ageFilter == "senior")">50+</option>
            </select>
        </div>

        <div class="col-md-3">
            <input type="text" class="form-control" name="searchTerm" placeholder="Search by Name or ID"
                   value="@(ViewBag.CurrentFilters?.searchTerm ?? "")" />
        </div>

        <div class="col-md-3 d-flex gap-3">
            <button type="submit" class="btn btn-primary flex-fill">Apply</button>
            <a asp-action="PatientList" class="btn btn-secondary flex-fill">Clear</a>
            <a asp-controller="Reports" asp-action="ExportDoctorsPatientsToPDF"
               asp-route-locationFilter="@ViewBag.CurrentFilters.locationFilter"
               asp-route-ageFilter="@ViewBag.CurrentFilters.ageFilter"
               asp-route-searchTerm="@ViewBag.CurrentFilters.searchTerm"
               class="btn btn-danger flex-fill">
                Export PDF
            </a>
        </div>
    </form>

    <div class="row">
        <!-- Table col -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                @if (!Model.Any())
                {
                    <div class="alert alert-info text-center">
                        No Patients Currently Admitted
                    </div>
                }
                else
                {
                    <div class="card-body">
                        <table class="table table-hover align-middle" id="AdmissionTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Patient Name</th>
                                    <th>ID Number</th>
                                    <th>Age</th>
                                    <th>Condition</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int count = 1;
                                }
                                @foreach (var admission in Model)
                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@admission.PatientName</td>
                                        <td>@admission.IdNumber</td>
                                        <td>@admission.Age</td>
                                        <td>@admission.Condition</td>
                                        <td>@admission.WardName</td>
                                        <td>
                                            @* existing action buttons *@
                                            @if (admission.FolderId != null && admission.FolderId > 0)
                                            {
                                                <a class="btn btn-outline-primary btn-sm view-vitals-btn"
                                                   data-folder-id="@admission.FolderId"
                                                   data-patient-name="@admission.PatientName">
                                                    View Vitals
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-secondary btn-sm" disabled title="Patient must be must have a folder to record vitals first">View Vitals</a>
                                            }
                                            @if (admission.Status == "Admitted")
                                            {
                                                <a asp-controller="Movement"
                                                   asp-action="Movement"
                                                   asp-route-admissionId="@admission.AdmissionId"
                                                   class="btn btn-outline-success btn-sm">
                                                    Movement
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-outline-success btn-sm" disabled title="Patient must be admitted first">Movement</a>

                                            }
                                            @if (admission.Status == "Admitted")
                                            {
                                                <a asp-controller="Doctor"
                                                   asp-action="DischargeForm"
                                                   asp-route-id="@admission.AppointmentId"
                                                   class="btn btn-warning btn-sm text-white">
                                                    Instruct Discharge
                                                </a>
                                            }
                                            else
                                            {
                                                <form asp-controller="Doctor" asp-action="CheckOutPatient" method="post" style="display:inline;">
                                                    <input type="hidden" name="appointmentId" value="@admission.AppointmentId" />
                                                    <button type="submit" class="btn btn-outline-secondary btn-sm">CheckOut</button>
                                                </form>

                                            }
                                        </td>
                                    </tr>
                                    count++;
                                }
                            </tbody>
                        </table>

                        @* paging partial *@
                        <div class="=container">
                            @if (pager.TotalPages > 0)
                            {
                                <ul class="pagination justify-content-end">
                                    @if (pager.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="1">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage - 1)">Previous</a>
                                        </li>
                                    }
                                    @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                    {
                                        <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@pge">@pge</a>
                                        </li>
                                    }
                                    @if (pager.CurrentPage < pager.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.CurrentPage + 1)">Next</a>
                                        </li>
                                        <li>
                                            <a class="page-link" asp-controller="Doctor" asp-action="PatientList" asp-route-pg="@(pager.TotalPages)">Last</a>
                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Right stats/graph column (copied pattern from RegisteredUsers with admissions graph) -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">Patient Statistics</h5>

                    <div class="row mb-3">
                        <!-- Total Patients -->
                        <div class="col-md-6">
                            <div class="d-flex align-items-center h-100">
                                <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                                    <i class="bi bi-hospital-fill text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Total</h6>
                                    <p class="fs-3 mb-0">@ViewBag.TotalPatients</p>
                                </div>
                            </div>
                        </div>

                        <!-- Admitted / CheckedIn -->
                        <div class="col-md-6">
                            <div class="d-flex align-items-center h-100">
                                <div class="bg-info bg-opacity-10 p-3 rounded me-3">
                                    <i class="bi bi-heart-pulse text-info fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">Status</h6>
                                    <p class="mb-0">
                                        Admitted: @ViewBag.AdmittedCount<br />
                                        Checked-In: @ViewBag.CheckedInCount
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Age Distribution -->
                    <div class="mb-3">
                        <h6>Age Distribution</h6>
                        <div class="progress mb-1" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: @ViewBag.YoungPercent%">
                                Under 30
                            </div>
                        </div>
                        <div class="progress mb-1" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: @ViewBag.MiddlePercent%">
                                30-49
                            </div>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: @ViewBag.SeniorPercent%">
                                50+
                            </div>
                        </div>
                    </div>

                    <!-- Admissions frequency chart -->
                    <div class="mb-3">
                        <h6>Admissions — Last 30 days</h6>
                        <div style="height:300px; width:100%;">
                            <canvas id="admissionsChart"></canvas>
                        </div>

                    </div>

                    <!-- Recent Admissions -->
                    <div class="mt-3">
                        <h6>Recent Admissions</h6>
                        <ul class="list-group list-group-flush">
                            @if (ViewBag.LatestAdmissions != null && ((IEnumerable<dynamic>)ViewBag.LatestAdmissions).Any())
                            {
                                <ul class="list-group">
                                    @foreach (var item in (IEnumerable<dynamic>)ViewBag.LatestAdmissions)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@item.FullName</strong><br />
                                                <small>ID: @item.IdNumber</small>
                                            </div>
                                            <span>
                                                <small>@item.AdmissionDate</small><br />
                                                <span class="badge bg-primary">@item.WardName</span>
                                            </span>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted">No recent admissions.</p>
                            }

                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a asp-action="Index" asp-controller="Doctor" class="btn btn-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById("toastMessage");
            if (toastEl) {
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // View Vitals modal logic (unchanged)
        $(document).ready(function() {
            let selectedFolderId = null;
            $(document).on('click', '.view-vitals-btn', function() {
               selectedFolderId = $(this).data('folder-id');
                const patientName = $(this).data('patient-name');
                $('#vitalsModalLabel').text(`Latest Vitals for ${patientName}`);
                loadVitals(selectedFolderId, true);
                $('#vitalsModal').modal('show');
            });

            $('#viewFullHistoryBtn').click(function() {
               if (selectedFolderId !== null) {
                    loadVitals(selectedFolderId, false);
               }
               $(this).hide();
            });

            function loadVitals(folderId, latestOnly) {
                $.ajax({
                    url: '@Url.Action("ViewVitals", "Doctor")',
                    type: 'GET',
                    data: {
                        folderId: folderId,
                        latestOnly: latestOnly
                    },
                    beforeSend: function() {
                        $('#vitalsModalBody').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                    },
                    success: function(data) {
                        $('#vitalsModalBody').html(data);
                        if (!latestOnly) {
                            $('#viewFullHistoryBtn').hide();
                        } else {
                            $('#viewFullHistoryBtn').show();
                        }
                    },
                    error: function() {
                        $('#vitalsModalBody').html('<div class="alert alert-danger">Error loading vitals data.</div>');
                    }
                });
            }

            $(document).on('keyup', '#searchInput', function() {
                const input = $(this).val().toLowerCase();
                $('#vitalsModalBody tbody tr').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.includes(input));
                });
            });

            // ---- Admissions Chart ----
            // Get JSON from server-provided ViewBag
            var labels = @Html.Raw(ViewBag.AdmissionChartLabelsJson ?? "[]");
            var counts = @Html.Raw(ViewBag.AdmissionChartDataJson ?? "[]");

            // load Chart.js if not present
            (function loadChartAndRender() {
                function renderChart() {
                    var ctx = document.getElementById('admissionsChart').getContext('2d');
                    // If a chart instance exists, destroy it before creating a new one (optional)
                    if (window.admissionsChartInstance) {
                        window.admissionsChartInstance.destroy();
                    }
                    window.admissionsChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Admissions',
                                data: counts,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 3,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 0,
                                        autoSkip: true,
                                        maxTicksLimit: 8
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    precision: 0,
                                    stepSize: 1
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            }
                        }
                    });
                }

                if (typeof Chart === 'undefined') {
                    // load Chart.js from CDN and then render
                    var script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js';
                    script.onload = renderChart;
                    document.head.appendChild(script);
                } else {
                    renderChart();
                }
            })();

        });
    </script>
}
